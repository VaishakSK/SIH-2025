<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Report - CivicConnect</title>
  <style>
    :root{
      --bg1:#f0f4f8; --bg2:#eaf2f7;
      --card:#ffffff; --muted:#616b7a;
      --accent:#06b6d4; --accent-2:#0ea5a4;
      --danger:#dc2626;
      --radius:14px; --shadow: 0 12px 40px rgba(2,6,23,0.06);
      --max-width:1400px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:
      radial-gradient(800px 300px at 10% 10%, rgba(6,182,212,0.06), transparent),
      linear-gradient(180deg,var(--bg1),var(--bg2));color:#071023}
    /* full-screen layout */
    .stage{width:100vw;height:100vh;display:flex;align-items:stretch;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:var(--max-width);height:100%;display:grid;grid-template-columns:1fr 420px;gap:24px}
    @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }

    .panel{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:26px;display:flex;flex-direction:column;gap:18px;border:1px solid rgba(7,16,35,0.04);overflow:auto;
    }

    .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{display:flex;flex-direction:column}
    .title h1{margin:0;font-size:20px;font-weight:800}
    .title p{margin:4px 0 0 0;color:var(--muted);font-size:13px}

    form{display:flex;flex-direction:column;gap:18px}

    /* form layout */
    .fields{display:grid;grid-template-columns:1fr;gap:14px}
    .row{display:flex;gap:14px}
    .col{flex:1;display:flex;flex-direction:column;gap:8px}
    label{font-weight:700;font-size:14px}
    input[type="text"], select, textarea{
      padding:12px;border-radius:10px;border:1px solid rgba(7,16,35,0.06);font-size:14px;background:linear-gradient(180deg, #fff, #fbfdfe);
      outline:none;
    }
    textarea{min-height:160px;resize:vertical}
    .muted{font-size:13px;color:var(--muted)}

    /* image drop area */
    .drop{
      height:380px;border-radius:12px;border:2px dashed rgba(7,16,35,0.06);display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);position:relative;overflow:hidden;
    }
    .drop.hover{border-color:rgba(6,182,212,0.8);box-shadow:0 10px 30px rgba(6,182,212,0.06)}
    .drop .placeholder{text-align:center;color:var(--muted)}
    .preview-img{width:100%;height:100%;object-fit:cover;display:block}

    .side{
      display:flex;flex-direction:column;gap:14px;
    }
    .card{background:linear-gradient(180deg,#fff,#fbfdfe);border-radius:12px;padding:14px;border:1px solid rgba(7,16,35,0.04)}
    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:800;cursor:pointer;
      box-shadow:0 10px 30px rgba(6,182,212,0.12)
    }
    .btn-ghost{background:transparent;border:1px solid rgba(7,16,35,0.06);color:#071023;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}

    .meta-row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .wordcount{font-weight:700}
    .progress{height:8px;background:#eef6f8;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

    /* footer */
    .actions{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:6px}

    @media (max-width:760px){
      .drop{height:260px}
      .wrap{padding:12px}
      .side{order:2}
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="wrap">
      <!-- left: form -->
      <section class="panel" aria-labelledby="createTitle">
        <div class="header">
          <div class="title">
            <h1 id="createTitle">Create Report</h1>
            <p class="muted">Capture the issue, add details and send to the concerned department.</p>
          </div>
          <div class="meta-row">
            <div class="muted">Max image size: 6MB • jpg/png/webp</div>
          </div>
        </div>

        <form id="reportForm" method="POST" action="/report" enctype="multipart/form-data" novalidate>
          <div class="fields">

            <!-- NEW: title -->
            <div class="col">
              <label for="title">Title (max 10 words)</label>
              <input id="title" name="title" type="text" required placeholder="Short title e.g. Pothole at Main St & 3rd Ave">
              <div class="muted" style="margin-top:6px">Keep it short — up to 10 words.</div>
            </div>

            <!-- existing photo & fields -->
            <div class="col">
              <label for="photo">Photo</label>
              <div id="dropZone" class="drop" role="region" aria-label="Image upload area">
                <div class="placeholder" id="dropPlaceholder">
                  <svg width="68" height="68" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v10" stroke="#0ea5a4" stroke-width="1.6" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="#0ea5a4" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <div style="margin-top:12px;font-weight:700">Drag & drop image here</div>
                  <div class="muted" style="margin-top:6px">or <label for="photo" style="color:var(--accent);text-decoration:underline;cursor:pointer">browse</label></div>
                </div>
                <img id="previewImg" class="preview-img" alt="Selected photo preview" style="display:none">
                <input id="photo" name="photo" type="file" accept="image/*" aria-hidden="true" style="display:none" required>
              </div>
            </div>

            <div class="col">
              <label for="department">Concerned Department</label>
              <select id="department" name="department" required>
                <option value="">Select department</option>
                <option value="sanitation">Sanitation</option>
                <option value="roads">Roads & Infrastructure</option>
                <option value="electricity">Electricity</option>
                <option value="water">Water Supply</option>
                <option value="others">Others</option>
              </select>
            </div>

            <div class="col">
              <label for="address">Address (exact)</label>
              <input id="address" name="address" type="text" required value="">
            </div>

            <div class="col">
              <label for="locationText">Location (from geotag) — optional</label>
              <div style="display:flex;gap:10px">
                <input id="locationText" name="locationText" type="text" placeholder="City, area or coordinates">
                <button type="button" id="locBtn" class="btn-ghost" aria-label="Use browser location">Use location</button>
              </div>
            </div>

            <div class="col">
              <label for="description">Description (30–250 words)</label>
              <textarea id="description" name="description" required placeholder="Describe the issue in detail..."></textarea>

              <div class="meta-row" style="margin-top:8px">
                <div class="muted"><span id="wordCount">Words: 0</span></div>
                <div style="width:160px">
                  <div class="progress" aria-hidden="true"><i id="wcProgress"></i></div>
                </div>
              </div>
            </div>
          </div>

          <div class="actions" aria-hidden="false">
            <a class="btn-ghost" href="/dashboard">Cancel</a>
            <button class="btn" type="submit" id="submitBtn">Submit Report</button>
          </div>
        </form>
      </section>

      <!-- right: info / preview -->
      <aside class="side">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Image Preview</h3>
          <div style="height:300px;border-radius:10px;overflow:hidden;background:#f7fbfc;display:flex;align-items:center;justify-content:center">
            <img id="sidePreview" alt="Preview" style="max-width:100%;max-height:100%;object-fit:cover;display:none">
            <div id="noPreview" class="muted">No image selected</div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Submission Tips</h4>
          <ul class="muted" style="margin:0 0 0 16px;padding:0;line-height:1.6">
            <li>Capture the issue clearly, with surrounding context.</li>
            <li>Provide exact address / landmark for faster action.</li>
            <li>Describe what happened (30–250 words).</li>
          </ul>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Status</h4>
          <p class="muted" id="statusInfo">After submission you will be redirected to your dashboard. Each report receives a unique ID and timestamp.</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    (function(){
      const drop = document.getElementById('dropZone');
      const photo = document.getElementById('photo');
      const previewImg = document.getElementById('previewImg');
      const sidePreview = document.getElementById('sidePreview');
      const noPreview = document.getElementById('noPreview');
      const desc = document.getElementById('description');
      const wc = document.getElementById('wordCount');
      const wcProgress = document.getElementById('wcProgress');
      const locBtn = document.getElementById('locBtn');
      const submitBtn = document.getElementById('submitBtn');
      const titleInput = document.getElementById('title');
      const maxBytes = 6 * 1024 * 1024;

      function setPreview(file){
        if (!file) { previewImg.style.display='none'; sidePreview.style.display='none'; noPreview.style.display='block'; return; }
        const url = URL.createObjectURL(file);
        previewImg.src = url; previewImg.style.display='block';
        sidePreview.src = url; sidePreview.style.display='block';
        noPreview.style.display='none';
      }

      // drag & drop
      ['dragenter','dragover'].forEach(ev => {
        drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.add('hover'); });
      });
      ['dragleave','drop'].forEach(ev => {
        drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.remove('hover'); });
      });
      drop.addEventListener('drop', (e)=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) handleFile(f);
      });

      // file selector
      drop.addEventListener('click', ()=> photo.click());
      photo.addEventListener('change', (e)=> {
        const f = e.target.files && e.target.files[0]; if (f) handleFile(f);
      });

      function handleFile(f){
        if (!f) return;
        if (f.size > maxBytes) { alert('Image too large (max 6MB)'); photo.value=''; return; }
        const allowed = ['image/jpeg','image/png','image/webp'];
        if (!allowed.includes(f.type)) { alert('Only jpg / png / webp allowed'); photo.value=''; return; }
        setPreview(f);
      }

      // description word count
      function updateWordCount(){
        const words = desc.value.trim().split(/\s+/).filter(Boolean).length;
        wc.textContent = 'Words: ' + words;
        // progress 0..100 based on recommended 30..250
        const min = 30, max = 250;
        const pct = Math.max(0, Math.min(100, Math.round(((words - min) / (max - min)) * 100)));
        wcProgress.style.width = pct + '%';
        wcProgress.style.background = (words < min || words > max) ? 'linear-gradient(90deg,var(--danger),#ff7b7b)' : 'linear-gradient(90deg,var(--accent),var(--accent-2))';
      }
      desc.addEventListener('input', updateWordCount);
      updateWordCount();

      // geolocation + reverse geocode
      locBtn.addEventListener('click', ()=>{
        if (!navigator.geolocation) return alert('Geolocation not supported');
        locBtn.disabled = true; locBtn.textContent = 'Locating...';
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          try{
            const res = await fetch('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+lat+'&lon='+lon);
            const data = await res.json();
            const label = data.display_name || (lat+','+lon);
            document.getElementById('locationText').value = label;
            const addr = document.getElementById('address');
            if (!addr.value) addr.value = label;
          }catch(e){
            document.getElementById('locationText').value = lat+','+lon;
          } finally { locBtn.disabled=false; locBtn.textContent='Use location'; }
        }, (err)=>{
          alert('Could not get location: ' + err.message);
          locBtn.disabled=false; locBtn.textContent='Use location';
        }, {timeout:10000});
      });

      // enforce title 1-10 words
      function titleWordCheck(){
        const words = (titleInput.value || '').trim().split(/\s+/).filter(Boolean).length;
        if (words > 10) {
          titleInput.setCustomValidity('Title must be 1–10 words');
        } else {
          titleInput.setCustomValidity('');
        }
      }
      titleInput.addEventListener('input', titleWordCheck);
      titleWordCheck();

      // submit validation
      document.getElementById('reportForm').addEventListener('submit', function(e){
        // title check
        const titleWords = (titleInput.value || '').trim().split(/\s+/).filter(Boolean).length;
        if (titleWords < 1 || titleWords > 10){
          e.preventDefault();
          alert('Title must be 1–10 words');
          titleInput.focus();
          return;
        }

        const words = desc.value.trim().split(/\s+/).filter(Boolean).length;
        if (words < 30 || words > 250){
          e.preventDefault();
          alert('Description must be between 30 and 250 words. Current: ' + words);
          desc.focus();
          return;
        }
        // ensure file selected
        const file = photo.files && photo.files[0];
        if (!file){
          e.preventDefault();
          alert('Please attach a photo of the issue.');
          return;
        }
        if (file.size > maxBytes){ e.preventDefault(); alert('Image too large (max 6MB).'); return; }
        submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
      });

      // init preview if file pre-selected
      if (photo.files && photo.files[0]) setPreview(photo.files[0]);
    })();
  </script>
</body>
</html>